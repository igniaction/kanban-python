pipeline {
  agent {
    dockerfile {
      filename 'ci/jenkins-agent.Dockerfile'
      args '-v /var/run/docker.sock:/var/run/docker.sock'
      reuseNode true
    }
  }

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    APP_NAME = "kanban-python"
  }

  stages {
    stage("Init") {
      steps {
        script {
          // Jenkins já fornece GIT_COMMIT após o checkout padrão
          env.GIT_SHA = (env.GIT_COMMIT ?: "").take(7)
          if (!env.GIT_SHA?.trim()) {
            env.GIT_SHA = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
          }
          echo "Commit SHA: ${env.GIT_SHA}"
        }
      }
    }

    stage("Lint") {
      steps {
        sh "make lint"
      }
    }

    stage("Test") {
      steps {
        sh "make test"
      }
    }

    stage("Build Docker Image") {
      steps {
        sh """
          docker build -t ${APP_NAME}:sha-${GIT_SHA} .
          docker image ls ${APP_NAME}:sha-${GIT_SHA}
        """
      }
    }
  }

  post {
    always {
      echo "Build finalizado: ${APP_NAME}:sha-${env.GIT_SHA}"
    }
  }
}
